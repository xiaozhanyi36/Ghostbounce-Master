/*
 * LiquidBounce+ Hacked Client
 * A free open source mixin-based injection hacked client for Minecraft using Minecraft Forge.
 * https://github.com/WYSI-Foundation/LiquidBouncePlus/
 */
package net.ccbluex.liquidbounce.features.module.modules.world

import net.ccbluex.liquidbounce.LiquidBounce
import net.ccbluex.liquidbounce.event.*
import net.ccbluex.liquidbounce.features.module.Module
import net.ccbluex.liquidbounce.features.module.ModuleCategory
import net.ccbluex.liquidbounce.features.module.ModuleInfo
import net.ccbluex.liquidbounce.ui.client.hud.element.elements.Notification
import net.ccbluex.liquidbounce.utils.ClientUtils
import net.ccbluex.liquidbounce.value.*
import net.minecraft.network.play.server.*

@ModuleInfo(name = "AntiExploit", spacedName = "Anti Exploit", description = "Prevent servers from doing certain harmful things.", category = ModuleCategory.WORLD, array = false)
class AntiExploit : Module() {

    init {
        state = true
    }

    val notifyValue = BoolValue("Notify", false)
    val guardianValue = BoolValue("LessGuardian", true)
    private val maxArrowSpawn = IntegerValue("MaxArrowPerSecond", 100, 1, 1000)

    private var tick = 0
    private var arrowMax = 0
    private var guardianEffect = false

    fun sendMessage(s: String, force: Boolean = false) {
		if (notifyValue.get() || force)
			ClientUtils.displayChatMessage("§7[§a§lAntiExploit§7]§6 $s")
	}

    override fun onDisable() {
        sendMessage("We highly recommend you to keep this module, AntiExploit enabled.", true)
    }

    @EventTarget
    fun onPacket(event: PacketEvent) {
        val packet = event.packet

        if (packet is S2BPacketChangeGameState) {
			if (packet.getGameState() == 5 && !mc.isDemo()) {
                event.cancelEvent()
                sendMessage("Illegal Demo GUI.")
            }
            if (packet.getGameState() == 10 && guardianValue.get()) {
                if (!guardianEffect)
                    guardianEffect = true
                else {
                    event.cancelEvent()
                    sendMessage("Limited Guardian Effect.")
                }
            }
		}

        if (packet is S0EPacketSpawnObject && packet.getType() == 60) {
            arrowMax++
            if (arrowMax > maxArrowSpawn.get()) {
                event.cancelEvent()
                sendMessage("Reached max arrow spawn per second.")
            }
        }
    }

    @EventTarget
    fun onUpdate(event: UpdateEvent) {
        tick++
        if (tick >= 20) {
            tick = 0
            arrowMax = 0
            guardianEffect = false
        }
    }
    
}